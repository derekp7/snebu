<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="keywords" content="Snebu, Linux Backup, Snapshot, Encrypting">
<title>SNEBU</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url(//fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */
:root{
--maincolor:#FFFFFF;
/*--primarycolor:#000000;*/
--primarycolor:#556B2F;
/*--secondarycolor:#AAAAAA;*/
--secondarycolor:#222222;
--tertiarycolor:#CCCCCC;
/*--sidebarbackground:#CACACA;*/
--sidebarbackground:#F0F0F0;
--linkcolor:#0D47A1;
--linkcoloralternate:#B71C1C;
--white:#FFFFFF;
--black:#676767;
}

/* Text styles */

body{font-family: "Noto Sans",sans-serif;background-color: var(--maincolor);color:var(--black);}

h1{color:var(--primarycolor) !important;font-family:"Noto Sans",sans-serif;}
h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;font-family:"Noto Sans",sans-serif;}
.title{color:var(--black) !important;font-family:"Noto Sans",sans-serif;font-style: normal; font-weight: normal;}
a{text-decoration: none;}
p{font-family: "Noto Sans",sans-serif ! important}
#toc.toc2 a:link{color:var(--linkcolor);}
blockquote{color:var(--secondarycolor) !important}
.quoteblock{color:var(--black)}
.quoteblock blockquote:before{color:var(--black)}
/*code{color:var(--white);background-color: var(--secondarycolor) !important}*/
code{color:var(--secondarycolor);background-color: var(--maincolor) !important}
mark{background-color: var(--tertiarycolor)} /* Text highlighting color */

/* Table styles */
th{background-color: var(--maincolor);color:var(--black) !important;}
td{background-color: var(--maincolor);color: var(--black) !important}


#toc.toc2{background-color:var(--sidebarbackground);}
#toctitle{color:var(--primarycolor);}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SNEBU</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_quick_start">2. Quick start</a>
<ul class="sectlevel2">
<li><a href="#_downloads_compiling_installation">2.1. Downloads / Compiling / Installation</a></li>
<li><a href="#_sample_backup_and_restore_operation">2.2. Sample Backup and Restore Operation</a></li>
</ul>
</li>
<li><a href="#_general_concepts">3. General concepts</a>
<ul class="sectlevel2">
<li><a href="#_components">3.1. Components</a></li>
<li><a href="#_encryption_2">3.2. Encryption</a></li>
<li><a href="#_other_security_features">3.3. Other security features</a></li>
</ul>
</li>
<li><a href="#_reference">4. Reference</a>
<ul class="sectlevel2">
<li><a href="#_snebu_client1_front_end_client_for_the_snebu_backup_system">4.1. snebu-client(1) - Front-end client for the snebu backup system</a></li>
<li><a href="#_snebu_client_backup1_initiates_a_backup">4.2. snebu-client-backup(1) - Initiates a backup</a></li>
<li><a href="#_snebu_client_listbackups1_lists_backed_up_systems_backup_sets_and_file_names">4.3. snebu-client-listbackups(1) - Lists backed up systems, backup sets, and file names</a></li>
<li><a href="#_snebu_client_validate1_compares_a_backup_to_file_system_contents">4.4. snebu-client-validate(1) - Compares a backup to file system contents</a></li>
<li><a href="#_snebu_client_restore1_restores_a_backup">4.5. snebu-client-restore(1) - Restores a backup</a></li>
<li><a href="#_snebu_client_conf5_configuration_file_for_snebu_client_front_end">4.6. snebu-client.conf(5) - Configuration file for snebu-client front end</a></li>
<li><a href="#_snebu_client_plugin5_defines_pre_backup_and_post_backup_scripts_to_run_on_a_client">4.7. snebu-client-plugin(5) - Defines pre-backup and post-backup scripts to run on a client.</a></li>
<li><a href="#_snebu1_the_simple_network_backup_system">4.8. snebu(1) - The simple network backup system</a></li>
<li><a href="#_snebu_newbackup1_submits_manifest_for_a_new_backup">4.9. snebu-newbackup(1) - Submits manifest for a new backup</a></li>
<li><a href="#_snebu_submitfiles1_recieves_tar_file_contents_to_complete_a_backup">4.10. snebu-submitfiles(1) - Recieves tar file contents to complete a backup</a></li>
<li><a href="#_snebu_listbackups1_lists_backed_up_systems_backup_sets_and_file_names">4.11. snebu-listbackups(1) - Lists backed up systems, backup sets, and file names</a></li>
<li><a href="#_snebu_restore1_generates_tar_file_from_backup">4.12. snebu-restore(1) - Generates tar file from backup</a></li>
<li><a href="#_snebu_expire1_expire_a_given_backup_set_or_range_of_backups">4.13. snebu-expire(1) - Expire a given backup set or range of backups</a></li>
<li><a href="#_snebu_purge1_remove_backing_files_from_expired_backups">4.14. snebu-purge(1) - Remove backing files from expired backups</a></li>
<li><a href="#_snebu_permissions1_set_permissions_for_snebu_when_used_in_multi_user_mode">4.15. snebu-permissions(1) - Set permissions for Snebu when used in multi-user mode</a></li>
<li><a href="#_tarcrypt1_compresses_and_encrypts_file_data_in_tar_files">4.16. tarcrypt(1) - Compresses and encrypts file data in TAR files</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<p style="color:rgb(150,150,150);"> Simple Network Encrypting Backup Utility</p>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Snebu is a high-performance snapshot-style backup system for Linux supporting compression, deduplication and optional public key encryption.  It can operate in single-host mode, push mode (client pushes data to server), or pull mode (server pulls data from client) via SSH.  In pull mode, no agent is required on the client (the program <em>tarcrypt</em> will need to be on clients when encryption is used).</p>
</div>
<div class="paragraph">
<p>The backups are snapshot style, so only the minimum necessary files are transferred to the backup server to complete a backup set.  This keeps storage and bandwidth utilization to a minimum.</p>
</div>
<div class="paragraph">
<p>Server side is accessed via SSH, supports multiple simultaneous clients, and deduplicates backup files across file systems, clients and backup sets.  Server access supports multi-user granular permissions per account (i.e., an account can be granted backup access, but forbidden delete access&#8201;&#8212;&#8201;useful for protection against malware attacks).</p>
</div>
<h3 id="_primary_features" class="discrete">Primary Features</h3>
<div class="ulist">
<ul>
<li>
<p>Centrally managed</p>
</li>
<li>
<p>Snapshot backups</p>
</li>
<li>
<p>Database-backed metadata catalog</p>
</li>
<li>
<p>File-level deduplication</p>
<div class="ulist">
<ul>
<li>
<p>Across backup sets and clients</p>
</li>
</ul>
</div>
</li>
<li>
<p>Compression</p>
</li>
<li>
<p>RSA Public Key encryption using <a href="https://www.snebu.com/tarcrypt">tarcrypt</a></p>
</li>
<li>
<p>Single-host, Client-push, or Server-pull backups</p>
</li>
<li>
<p>Multiple user granular access</p>
</li>
<li>
<p>Agentless</p>
<div class="ulist">
<ul>
<li>
<p>Client-side uses standard Unix/Linux commands&#8201;&#8212;&#8201;<em>find</em>, <em>tar</em>, <em>ssh</em>, <em>bash</em></p>
</li>
</ul>
</div>
</li>
<li>
<p>High efficiency C code</p>
<div class="ulist">
<ul>
<li>
<p>Minimal library runtime dependencies&#8201;&#8212;&#8201;<em>SQLite</em>, <em>OpenSSL</em>, <em>LZOP</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>SNEBU&#8201;&#8212;&#8201;Sleep Nominally, Everything&#8217;s Backed Up.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start">2. Quick start</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_downloads_compiling_installation">2.1. Downloads / Compiling / Installation</h3>
<h4 id="_source" class="discrete">Source</h4>
<div class="ulist">
<ul>
<li>
<p>Download <a href="https://github.com/derekp7/snebu/releases/download/v1.1.1/snebu-1.1.1.tar.gz">snebu-1.1.1.tar.gz</a></p>
</li>
<li>
<p>Extract the tar file, run make, then sudo make install.</p>
<div class="literalblock">
<div class="content">
<pre>tar -zxvf snebu-1.1.1.tar.gz
make
sudo make install</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then to set up privilege separation:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo useradd -r -U -d /var/lib/snebu snebu
sudo chown snebu:snebu</pre>
</div>
</div>
<div class="paragraph">
<p>This creates a user and group called "snebu", installing the snebu binary as SUID to user "snebu".  The config file /etc/sneub.conf defaults to placing the vault in <code>/var/lib/snebu/vault</code> and the backup catalog DB in <code>/var/lib/snebu/catalog</code>.  The <code>vault</code> directory is where the backed up files are stored, and the <code>catalog</code> directory holds the backup catalog database (in SQLite format).</p>
</div>
<h4 id="_rpm" class="discrete">RPM</h4>
<div class="ulist">
<ul>
<li>
<p>Download <a href="https://github.com/derekp7/snebu/releases/download/v1.1.1/snebu-1.1.1-1.fc33.x86_64.rpm">snebu-1.1.1-1.fc33.x86_64.rpm</a></p>
<div class="literalblock">
<div class="content">
<pre>dnf install ./snebu-1.1.1-1.fc33.x86_64.rpm</pre>
</div>
</div>
</li>
<li>
<p>Or rebuild from source (requires gcc, rpm-build, openssl-devel, sqlite-devel, lzo-devel): <a href="https://github.com/derekp7/snebu/releases/download/v1.1.1/snebu-1.1.1-1.fc33.src.rpm">snebu-1.1.1-1.fc33.src.rpm</a></p>
<div class="literalblock">
<div class="content">
<pre>rpmbuild --rebuild snebu-1.1.1-1.fc33.src.rpm</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can mount an external storage device on /var/lib/snebu (making sure the <code>snebu</code> user/group owns the directory after mounting&#8201;&#8212;&#8201;if not, <code>chown snebu:snebu /var/lib/snebu/</code> once the drive is mounted).  However, if the storage device has slow seek times, which is the case with many 2.5" USB-powered mechanical hard drives, then you will get better performance by mounting the mechanical drive under <code>/var/lib/snebu/vault</code>, and mounting a separate SSD drive in <code>/var/lib/snebu/catalog</code> (or the appropriate directories specified in <code>/etc/snebu.conf</code>.  Or if you keep the <code>catalog</code> directory on the local systems drive then be sure to separately copy the contents of the catalog directory to the external storage device after a backup session finishes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sample_backup_and_restore_operation">2.2. Sample Backup and Restore Operation</h3>
<div class="sect3">
<h4 id="_user_and_permissions_setup">User and permissions setup</h4>
<div class="paragraph">
<p>You will need to set up user permissions for any user ID that access the <code>snebu</code> binary.  To set up permissions for the <code>root</code> user, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo -u snebu snebu permissions --add --command '*' --name '*' --user root</pre>
</div>
</div>
<div class="paragraph">
<p>If a user other than root needs to run snebu, then they need to be added to the snebu group.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_backup">Run a backup</h4>
<div class="paragraph">
<p><code>sudo</code> is needed here to allow snebu-client to read all the files on the host.  If a user is only backing up their own directory then sudo isn&#8217;t needed, and they can be given more granular permissions to the <code>snebu</code> command&#8201;&#8212;&#8201;see the man page snebu-permissions(1).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu-client backup</pre>
</div>
</div>
<div class="paragraph">
<p>This backs up all mounted disk-based file systems (automatically skips tmpfs, procfs, sysfs, and other "nodev" mount points).  The backup name defaults to the host name of the client, however this can be overridden with <code>--name</code> parameter.  You can also follow the command with a file or path list.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu-client backup -n boss-home-dir /home/bigboss</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_list_backups_contents_and_restore_a_file">List backups, contents, and restore a file</h4>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu-client listbackups -v

bosshost1
    1608761077 / daily / Wed Dec 23 16:04:37 2020</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu-client listbackups -n bosshost1 -d 1608761077 '*BudgetProposal*'

/home/bigboss/BudgetProposal2021.doc</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu-client restore -n bosshost1 -d 1608761077 -C /tmp \
    --graft /home/bigboss/=bigboss-restored

 bigboss-restored/BudgetProposal2021.doc</pre>
</div>
</div>
<div class="paragraph">
<p>The first command gives a list of all hosts that have been backed up.  With the "-v" flag, it will also give all backup sets that are part of each backed up host.  Backup sets are identified by a serial number, which is the time/date that the backup was created, represented in Unix time_t format (i.e., the number of seconds since Jan 1, 1970).</p>
</div>
<div class="paragraph">
<p>The second command will list the files that are part of the host and backup set, restricting the output to the given file specification.</p>
</div>
<div class="paragraph">
<p>In the third command, a restore of this backup set is initiated.  The client changes to the "/tmp" directory, so everything restored is relative to this directory (or specify <code>-C /</code> to restore to the original location).  The <code>--graft</code> parameter is specified to re-write part of the file path&#8201;&#8212;&#8201;in this case it replaces the directory "/home/bigboss/" with "bigboss-restored".  Putting it together the final path file that gets restored is in <code>/tmp/bigobss-restored/BudgetProposal2021.doc</code>.</p>
</div>
<div class="paragraph">
<p>Notice that the backup above is a "daily" backup&#8201;&#8212;&#8201;this is the retention schedule that this backup set is assigned to.  By default, backups ran on Sunday through Friaday are <code>daily</code> backups, Saturday is a <code>weekly</code> backup, and the first of the month is a <code>monthly</code> backup.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remote_backups">Remote backups</h4>
<div class="paragraph">
<p>If snebu is installed in a remote backup server called <code>bkupsvr1</code>, and you have the snebu-client script on a local host, you can add the parameters <code>--backup-server bkupsvr1</code> and <code>--backup-user svc-bosshost1</code> to the above commands.  Make sure to create the service user account <code>svc-bosshost1</code> on the remote host (or whichever user account name specified by your organizations practices), along with adding the account to the snebu group.  Set up ssh key based authentication for unattended backups, and then create the appropriate permissions for this service user on the remote backup server:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>admin@bkupsvr1:~$ sudo -u snebu snebu permissions --add --command '*' \
    --name 'bosshost1' --user svc-bosshost1</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can back up to this host:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>root@booshost1:~$ sudo snebu-client backup --backup-server bkupsvr1 --backup-user svc-bosshost1</pre>
</div>
</div>
<div class="paragraph">
<p>Note, you may wish to grant more granular permissions such as "backup", "listbackups" and "restore" in the above <code>snebu permissions</code> command.  This would prevent the client from deleting backups on the backup server if it were to become compromised.  See the <code>snebu-permissions</code> man page for detailed command usage.</p>
</div>
<div class="paragraph">
<p>If you want more protection, you can reverse the process and have the remote backup server "pull" a backup from the client:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>snebu@bkupsvr1:~$ snebu-client backup --remote-client bosshost1 \
    --remote-user root --sudo svs-backup</pre>
</div>
</div>
<div class="paragraph">
<p>This will access bosshost1 as the service user <code>svs-backup</code>, then sudo to <code>root</code> to pull the data.  Make sure to set up ssh key authentication between <code>snebu@bkupsvr1</code> and <code>svs-backup@bosshost1</code>.  If you leave off the <code>--sudo</code> flag, then the user <code>root</code> will be directly accessed via ssh (requiring ssh key authorization to <code>root@bosshost1</code>)</p>
</div>
</div>
<div class="sect3">
<h4 id="_expiring_old_backups">Expiring old backups</h4>
<div class="paragraph">
<p>Run the following on the backup server to expire old backups</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo snebu expire -a 14 -r daily
$ sudo snebu exipre -a 42 -r weekly
$ sudo snebu expire -a 365 -r monthly
$ sudo snebu purge</pre>
</div>
</div>
<div class="paragraph">
<p>This expires all daily backups older than 2 weeks, weekly backups older than 6 weeks, and monthly backups older than a year.  Expiring a backup only removes the metadata, and takes a short amount of time.  A <code>purge</code> permanently remove data from the <code>vault</code>, and can take a bit longer (depending on the number of files that need to be removed).</p>
</div>
<div class="paragraph">
<p>In the above example, the commands were run under the user ID <code>snebu</code>, which owns the repository and has all permissions.  Again, you can grant a specific user permission to run the expire and purge commands to limit the need to access the main user account (see <em>snebu-permissions(1)</em> documentation).</p>
</div>
</div>
<div class="sect3">
<h4 id="_encryption">Encryption</h4>
<div class="paragraph">
<p>Snebu supports client-side public key encryption.  This requires the program <code>tarcrypt</code> to be installed on the client.  On the client, run the command <code>tarcrypt genkey -f outputfile</code>, and make sure it has appropriate permissions and ownership</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo tarcrypt genkey -f /etc/snebu-backup.key
$ sudo chown root:root /etc/snebu-backup.key
$ sudo chmod 600 /etc/snebu-backup.key</pre>
</div>
</div>
<div class="paragraph">
<p>You will be prompted for a passphrase to protect the private key stored in the <code>.key</code> file.  Then, on any of the backup command variations, add the parameter <code>--encryption-key /etc/snebu-backup.key</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo snebu-client backup --backup-server bkupsvr1 --backup-user svc-bosshost1 \
    --encryption-key /etc/snebu-backup.key</pre>
</div>
</div>
<div class="paragraph">
<p>Note, you can repeate the <code>--encryption-key</code> parameter to encrypt with multiple keys&#8201;&#8212;&#8201;in this case, the passphrase for any one of the keys can be used to decode the backup upon restoring.</p>
</div>
<div class="paragraph">
<p>When restoring an encrypted backup, specify <code>snebu-client restore --decrypt</code> along with the other parameters as appropriate.  No key file is specified, as all key data is securely stored with the backup.  You will be prompted for the private key passphrase for one of the keys when restoring.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_concepts">3. General concepts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_components">3.1. Components</h3>
<div class="paragraph">
<p>The Snebu backup system consists of a backend process <code>snebu</code>, which maintains a backup catalog in an SQLite database <code>snebu-catalog.db</code> in the directory specified in the <code>/etc/snebu.conf</code> file.  This database has a number of tables, containing entries for each host that is backed up, along with the backup sets, all file metadata, and backup set details which relate the contents of a given backup set snapshot to to files in the file details table.  Individual file contents are compressed and a file hash is computed.  The files are stored in file names reflecting the file hash in the vault directory (again as specified in the config file).  Storing files named by the hash of the file contents leads directly to file-level deduplication across directories and hosts.</p>
</div>
<div class="paragraph">
<p>When initiating a backup, a file manifest of the system to be backed up is sent to <code>snebu</code>&#8201;&#8212;&#8201;this manifest consists of a list of file names and all associated metadata (ownership, permissions, size, modification times, etc).  This represents a complete snapshot of backed up file set.  This manifest gets processed to determine which files are already on the backup server.  The names of new and modified files (as determined by changes in <em>any</em> of the metadata fields) are returned to the client, which is then passed to the <code>tar</code> command to process and create a backup.</p>
</div>
<div class="paragraph">
<p>The output of <code>tar</code> is then ingested by the <code>snebu</code> backend process, which extracts the file names and meta data, then compresses the contents of each file to a temporary staging file in the <code>vault</code> location.  After computing a sha1 hash of the file, the file is renamed to this hash and placed in the target location in the vault.</p>
</div>
<div class="paragraph">
<p>The <code>snebu-client</code> program acts as a front end to <code>snebu</code>.  Technically it isn&#8217;t necessary, however you would need to generate the manifest manually (using <code>find</code> and a specific list of <code>-printf</code> specifiers&#8201;&#8212;&#8201;consult the man page <code>snebu-newbackup(1)</code> for details), and send it into <code>snebu --newbackup</code>, capture the return manifest to use to generate a <code>tar</code> file, and finally sending that into <code>snebu --submitfiles</code>.</p>
</div>
<div class="paragraph">
<p>Note, that some subcommands share the same name between <code>snebu</code> and <code>snebu-client</code>.  In some cases, such as <code>listbackups</code>, there is a bit more front-end processing provided by <code>snebu-client</code>.  In other cases, such as <code>restore</code>, the actions are different.  <code>snebu restore</code> synthesizes a <code>tar</code> file on standard output, whereas <code>snebu-client restore</code> executes <code>snebu restore</code> and calls the local <code>tar</code> command to extract the files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_encryption_2">3.2. Encryption</h3>
<div class="paragraph">
<p>Since <code>snebu</code> uses <code>tar</code> as a serialization format for the backup data, the <code>tarcrypt</code> command was created to act as a filter in a <code>tar</code> pipeline in order to add encryption capabilities.  The key used by <code>tarcrypt</code> contains an RSA Public key which is used to encrypt a random session key for each file.  It also contains a secret HMAC key used to "sign" each file in the backup with a deterministic hash.  The HMAC key is computed using a combination of the RSA Public key and the passphrase used to protect the RSA Private key.  That way it can not only be reliably regenerated during a restore operation (since the user needs to input the same passphrase to decrypt the backup), but it is also directly tied to the combination of the RSA keys and passphrase.  Since the HMAC key is considered sensitive, the <code>.key</code> file should be stored with appropriate restricted ownership and permissions to prevent an attacker from forging backup file contents (although a compromised HMAC key still won&#8217;t permit an attacker from decrypting a backup).</p>
</div>
<div class="paragraph">
<p>Since the backup server can&#8217;t know the hash of the raw file, and since a random session key is used when encrypting, that means that the has of the received file can&#8217;t be utilized for deduplication purposes.  However since the HMAC signature is deterministic, this signature is utilized for deduplication purposes which works to deduplicate across any hosts that share the same key file(s).  (When multiple keys are used during encryption, a hash of all the HMAC keys is used to name the file).</p>
</div>
<div class="paragraph">
<p>If a new key is generated, then subsequent backups will consist of files encrypted with the old key and the new one (since backups are snapshot based, only new/modified files get sent to the backup server and encrypted with the new key).  The <code>tarcrypt</code> command handles this gracefully&#8201;&#8212;&#8201;the global header contains all the encrypted keys used that are related to the files in the restore set, so the operator will be prompted for the passphrase for each key.  As an ease-of-use operation, if the same passphrase is used on more than one key, it only has to be entered once&#8201;&#8212;&#8201;it will automatically be tested against all keys.</p>
</div>
<div class="paragraph">
<p>You also have the option to force a full backup, which will re-send all files on the client to the backup server, if you don&#8217;t want to deal with multiple keys, by specifying the <code>--force-full</code> parameter (<code>snebu-client backup --force-full &#8230;&#8203;</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_security_features">3.3. Other security features</h3>
<div class="paragraph">
<p>If the <code>snebu</code> binary is installed with the suid bit set, then the user that owns it (the <code>snebu</code> user in the default case) will own the backup catalog database and the data vault.  Other users on the system can be given access to specific features, restricted to the specified hosts by using the <code>snebu permissions</code> subcommand.  For example you can give a user access to back up their host, but not restore.  Or you can restrict their ability to expire backups&#8201;&#8212;&#8201;either give permission for a host to only expire their own backups, or restrict expire option to a separate locked down account.  This can be valuable to prevent an attacker from deleting all the backups if a host is compromised.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reference">4. Reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_snebu_client1_front_end_client_for_the_snebu_backup_system">4.1. snebu-client(1) - Front-end client for the snebu backup system</h3>
<div class="listingblock">
<div class="content">
<pre>snebu-client [ subcommand ] [ options ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description">Description</h4>
<div class="paragraph">
<p>snebu-client is the client front end for snebu.
Use it to easily
back up a local or remote host, to either local a local storage
device, or to a remote backup server.  Use it with one of the
following subcommands.</p>
</div>
<h4 id="_sub_commands_are_as_follows" class="discrete">Sub commands are as follows:</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>backup</strong> [ <strong>-n</strong> <em>backupname</em> ] [ <strong>-d</strong> <em>datestamp</em> ] [ <strong>-r</strong> <em>schedule</em> ]</dt>
<dd>
<p>Initiates a backup.</p>
</dd>
<dt class="hdlist1"><strong>restore</strong> [ <strong>-n</strong> <em>backupname</em> ] [ <strong>-d</strong> <em>datestamp</em> ]</dt>
<dd>
<p>Initiates a restore.</p>
</dd>
<dt class="hdlist1"><strong>listbackups</strong> [ <strong>-n</strong> <em>backupname</em> [ <strong>-d</strong> <em>datestamp</em> ]] [ <em>file_list</em>&#8230;&#8203; ]</dt>
<dd>
<p>List backed up hosts, backup sets within a host, or files within a backup set.</p>
</dd>
<dt class="hdlist1"><strong>validate</strong> <strong>-n</strong> <em>backupname</em> <strong>-d</strong> <em>datestamp</em></dt>
<dd>
<p>Validates a given backup.</p>
</dd>
<dt class="hdlist1"><strong>help</strong> [ <em>subcommand</em> ]</dt>
<dd>
<p>Displays help page of subcommand</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also">See Also</h4>
<div class="paragraph">
<p><strong>snebu-client-backup</strong>(1),
<strong>snebu-client-restore</strong>(1),
<strong>snebu-client-listbackups</strong>(1),
<strong>snebu-client-validate</strong>(1),</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_backup1_initiates_a_backup">4.2. snebu-client-backup(1) - Initiates a backup</h3>
<div class="listingblock">
<div class="content">
<pre>snebu-client backup  [ -n backupname ] [ -d datestamp ] [ -r schedule ] [ file-list ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_2">Description</h4>
<div class="paragraph">
<p>Initiates a system backup.
By default, it will back up the local host to a local snebu install.
You can also use this command to back up to a remote backup server,
back up a remote host to either a local snebu installation,
or back up a remote host to another remote backup server,
depending on which options are chosen.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-c</strong>, <strong>--config</strong> <em>config_file</em></dt>
<dd>
<p>Name of the configuration file.  Default is
<em>/etc/snebu-client.conf</em>.</p>
</dd>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date&nbsp;+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>-r</strong>, <strong>--retention</strong> <em>schedule</em></dt>
<dd>
<p>Retention schedule for this backup set.  Typical
values are "daily", "weekly", "monthly", "yearly".</p>
</dd>
<dt class="hdlist1"><strong>-k</strong>, <strong>--encryption-key</strong> <em>keyfile</em></dt>
<dd>
<p>Turns on encryption, and specifies encryption
key location.  May be specified more than once to
encrypt with multiple keys.</p>
<div class="ulist">
<ul>
<li>
<p>The program "tarcrypt" needs to be present on the
client for this option.  Keys are generated with
the command:</p>
</li>
<li>
<p><strong>tarcrypt genkey -f</strong> <em>keyfile</em> [ <strong>-c</strong> <em>comment</em> ]</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><strong>-C</strong>, <strong>--changedir</strong> <em>path</em></dt>
<dd>
<p>Changes to the given directory path before backing up.</p>
</dd>
<dt class="hdlist1"><strong>--graft</strong> <em>/path/name/</em>*=*<em>/new/name/</em></dt>
<dd>
<p>Re-write path names beginning with "<em>/path/name/</em>"
to "<em>/new/name/</em>"</p>
</dd>
<dt class="hdlist1"><strong>-f</strong>, <strong>--force-full</strong></dt>
<dd>
<p>Force a full backup</p>
</dd>
<dt class="hdlist1"><strong>--remote-client</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of remote host.  Used to
backup a remote host to local backup server.</p>
</dd>
<dt class="hdlist1"><strong>--remote-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote remote-client.  Defaults to
root.</p>
</dd>
<dt class="hdlist1"><strong>--sudo</strong> <em>userid</em></dt>
<dd>
<p>Initial login User ID for remote remote-client.
This ID uses sudo to switch to remote-user once
logged in.</p>
</dd>
<dt class="hdlist1"><strong>--backup-server</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of backup server.  Used to
backup to a remote server.</p>
</dd>
<dt class="hdlist1"><strong>--backup-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote backup-server.</p>
</dd>
<dt class="hdlist1"><strong>--plugin</strong> <em>scriptname</em></dt>
<dd>
<p>Specifies an optional plug in script.  Usually
used to perform database-specific operations
(such as enabling hot backup mode) for systems
with a DB installed.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files to backup.
Overrides default specified in snebu-client.conf file.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_2">See Also</h4>
<div class="paragraph">
<p><strong>tarcrypt</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_listbackups1_lists_backed_up_systems_backup_sets_and_file_names">4.3. snebu-client-listbackups(1) - Lists backed up systems, backup sets, and file names</h3>
<div class="listingblock">
<div class="content">
<pre>snebu-client listbackups [ -n hostname [ -d datestamp ]] [ file_list... ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_3">Description</h4>
<div class="paragraph">
<p>With no arguments specified, "listbackups" will return a list of all
systems that are contained in the backup catalog.  Otherwise, when
specifying the <strong>-n</strong> parameter, a list of backup sets for that host is
returned.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_2">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-c</strong>, <strong>--config</strong> <em>config_file</em></dt>
<dd>
<p>Name of the configuration file.
Default is <em>/etc/snebu-client.conf</em>.</p>
</dd>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.
Usually set to the server name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.
The format is in <em>time_t</em> format,
sames as the output of the "date&nbsp;+%s" command.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files to restore.  Defaults to all.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_validate1_compares_a_backup_to_file_system_contents">4.4. snebu-client-validate(1) - Compares a backup to file system contents</h3>
<div class="listingblock">
<div class="content">
<pre>snebu-client validate -n backupname -d datestamp [ file-list ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_4">Description</h4>
<div class="paragraph">
<p>Compares the contents a given backup session identified by "-n" and "-d"
parameters, to what is on the client.  Use the "listbackups" subcommand to
get a list of available
backup sessions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_3">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-c</strong>, <strong>--config</strong> <em>config_file</em></dt>
<dd>
<p>Name of the configuration file.  Default is
<em>/etc/snebu-client.conf</em>.</p>
</dd>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date
+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>--decrypt</strong></dt>
<dd>
<p>Turns on decryption.  Requires "tarcrypt" to be
on the client.  Password(s) will be prompted for
during restore.</p>
</dd>
<dt class="hdlist1"><strong>-C</strong>, <strong>--changedir</strong> <em>path</em></dt>
<dd>
<p>Changes to the given directory path before validating</p>
</dd>
<dt class="hdlist1"><strong>--remote-client</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of remote host.  Used to
backup a remote host to local backup server.</p>
</dd>
<dt class="hdlist1"><strong>--remote-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote remote-client.  Defaults to
root.</p>
</dd>
<dt class="hdlist1"><strong>--sudo</strong> <em>userid</em></dt>
<dd>
<p>Initial login User ID for remote remote-client.
This ID uses sudo to switch to remote-user once
logged in.</p>
</dd>
<dt class="hdlist1"><strong>--backup-server</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of backup server.  Used to
backup to a remote server.</p>
</dd>
<dt class="hdlist1"><strong>--backup-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote backup-server.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files to validate.  Defaults to all.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_3">See Also</h4>
<div class="paragraph">
<p><strong>tarcrypt</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_restore1_restores_a_backup">4.5. snebu-client-restore(1) - Restores a backup</h3>
<div class="listingblock">
<div class="content">
<pre>snebu-client restore [ -n backupname ] [ -d datestamp ] [ file-list ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_5">Description</h4>
<div class="paragraph">
<p>Restores a given backup session identified by "-n" and "-d"
parameters.  Use the "listbackups" subcommand to get a list of
available backup sessions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_4">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-c</strong>, <strong>--config</strong> <em>config_file</em></dt>
<dd>
<p>Name of the configuration file.  Default is
<em>/etc/snebu-client.conf</em>.</p>
</dd>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date
+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>--decrypt</strong></dt>
<dd>
<p>Turns on decryption.  Requires "tarcrypt" to be
on the client.  Password(s) will be prompted for
during restore.</p>
</dd>
<dt class="hdlist1"><strong>-C</strong>, <strong>--changedir</strong> <em>path</em></dt>
<dd>
<p>Changes to the given directory path before restoring.</p>
</dd>
<dt class="hdlist1"><strong>--graft</strong> <em>/path/name/</em>*=*<em>/new/name/</em></dt>
<dd>
<p>Re-write path names beginning with "<em>/path/name/</em>"
to "<em>/new/name/</em>"</p>
</dd>
<dt class="hdlist1"><strong>--remote-client</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of remote host.  Used to
backup a remote host to local backup server.</p>
</dd>
<dt class="hdlist1"><strong>--remote-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote remote-client.
Defaults to root.</p>
</dd>
<dt class="hdlist1"><strong>--sudo</strong> <em>userid</em></dt>
<dd>
<p>Initial login User ID for remote remote-client.
This ID uses sudo to switch to remote-user once
logged in.</p>
</dd>
<dt class="hdlist1"><strong>--backup-server</strong> <em>hostname</em></dt>
<dd>
<p>Host name / IP address of backup server.  Used to
backup to a remote server.</p>
</dd>
<dt class="hdlist1"><strong>--backup-user</strong> <em>userid</em></dt>
<dd>
<p>User ID for remote backup-server.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files to restore.  Defaults to all.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_4">See Also</h4>
<div class="paragraph">
<p><strong>tarcrypt</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_conf5_configuration_file_for_snebu_client_front_end">4.6. snebu-client.conf(5) - Configuration file for snebu-client front end</h3>
<div class="sect3">
<h4 id="_description_6">Description</h4>
<div class="paragraph">
<p>The sneub-client.conf is used to specify a number of default parameters for snebu-client, such as default include / exclude specifications.  The contents are read in and executed as shell script commands by snebu-client, so in addition to specifying parameters it is possible to include standard shell scripting logic.  This also means that parameters are specified without a space between the name and value.</p>
</div>
<h4 id="_parameters" class="discrete">Parameters</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>INCLUDE</strong>=( <em>path</em> &#8230;&#8203; )</dt>
<dd>
<p>Specifies the directories to include in the backup.  By default, all mounted storage-based file systems are included&#8201;&#8212;&#8201;that is, file systems that are of type "NODEV" (which includes virtual file systems such as /proc, /sys, anything mounted as "tmpdir") are not included.</p>
<div class="paragraph">
<p>Also note that file system boundaries are not crossed automatically.  For example, if "/home" is a separate mount point from "/" then you will need to specify both "/" and "/home".  Mount points are specified explicitly to prevent virtual file systems (i.e., "/proc") from being inadvertently included.</p>
</div>
</dd>
<dt class="hdlist1"><strong>EXCLUDE</strong>=( <em>path</em> &#8230;&#8203;)</dt>
<dd>
<p>Excludes directories that would normally be included with the above INCLUDE parameter.</p>
</dd>
<dt class="hdlist1"><strong>EXCLUDEMATCH</strong>=( <em>filespec</em>&#8230;&#8203; )</dt>
<dd>
<p>Similar to EXCLUDE, however works with files matching a given pattern (processing shell wildcard expansion).  Note that individual parameters need to be quoted to prevent wildcard expansion from matching only files in the current directory.</p>
</dd>
<dt class="hdlist1"><strong>backupname</strong>=<em>name-of-backup</em></dt>
<dd>
<p>Give the backup the given name instead of defaulting to the hostname.</p>
</dd>
</dl>
</div>
<h4 id="_server_initiated_backup_notes" class="discrete">Server-initiated backup notes</h4>
<div class="paragraph">
<p>If running backups from a backup server, the parameters will by default apply to all clients.  To target parameters for specific clients, you can wrap them in a shell scripting conditional clause (if-then-else, or case statement).</p>
</div>
</div>
<div class="sect3">
<h4 id="_examples">Examples:</h4>
<div class="paragraph">
<p>To include specified directories:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>INCLUDE=( / /var /var/log /home )</pre>
</div>
</div>
<div class="paragraph">
<p>To exclude /tmp and /var/tmp</p>
</div>
<div class="literalblock">
<div class="content">
<pre>EXCLUDE=( /tmp /var/tmp )</pre>
</div>
</div>
<div class="paragraph">
<p>To exclude all ".tmp" and ".dbf" files</p>
</div>
<div class="literalblock">
<div class="content">
<pre>EXCLUDEMATCH=( "*.tmp" "*.dbf" )</pre>
</div>
</div>
<div class="paragraph">
<p>On a server backing up multiple clients&#8201;&#8212;&#8201;to exclude all database ".dbf" files only on the database server "erp-database", include the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>if [ "${clientname}" = "erp-database" ]
then
    EXCLUDEMATCH=( "*.dbf" )
fi</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_client_plugin5_defines_pre_backup_and_post_backup_scripts_to_run_on_a_client">4.7. snebu-client-plugin(5) - Defines pre-backup and post-backup scripts to run on a client.</h3>
<div class="sect3">
<h4 id="_description_7">Description</h4>
<div class="paragraph">
<p>Specifying the <strong>--plugin</strong> argument when executing a snebu-client backup operation will cause the specified plugin script to be incorporated into the backup process.  The plugin script defines at least two shell script functions&#8201;&#8212;&#8201;-fBpluginpre(), which executes prior to the backup, and pluginpost()\R which executes after the backup has completed.</p>
</div>
<div class="paragraph">
<p>This allows performing operations such as mounting a file system snapshot prior to a backup and removing the snapshot afterwards, or placing a database in hot backup mode at the beginning of the backup.  In the case of backing up a database, often times the backup will need to be completed in multiple stages&#8201;&#8212;&#8201;place the DB in hot backup mode, gather a list of database files, back them up, take the DB out of hot backup mode, gather a list of files containing transaction logs that were created during the backup, and finally backing up those files.</p>
</div>
<div class="paragraph">
<p>To facilitate these type of backup steps, the <strong>pluginpre</strong> function can save the contents of the file include/exclude variables <strong>INCLUDE</strong>, <strong>EXCLUDE</strong>, and <strong>EXCLUDEMATCH</strong>.  Then set the variable <strong>bkrepeat=1</strong>, along with setting any other housekeeping variables used inside the plugin script.  Once it has completed the last stage, it can then restore the include/exclude variables, let the rest of the backup process continue, and then set <strong>bkrepeat=0</strong> to finish off the backup.</p>
</div>
<h4 id="_functions_and_variables" class="discrete">Functions and Variables</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>pluginpre()</strong></dt>
<dd>
<p>Shell script code containing pre-backup procedures.</p>
</dd>
<dt class="hdlist1"><strong>pluginpost()</strong></dt>
<dd>
<p>Shell script code containing post-backup procedures.</p>
</dd>
<dt class="hdlist1"><strong>bkrepeat</strong></dt>
<dd>
<p>Set bkrepeat=1 to repeat the backup with modifications to the include/exclude list.  Every time the backup repeats, the backup set is amended with the new file set.</p>
</dd>
<dt class="hdlist1"><strong>INCLUDE</strong></dt>
<dd>
<p>Shell array containing file include list (see <strong>snebu-client.conf(5)</strong>)</p>
</dd>
<dt class="hdlist1"><strong>EXCLUDE</strong></dt>
<dd>
<p>Shell array containing file exclude list (see <strong>snebu-client.conf(5)</strong>)</p>
</dd>
<dt class="hdlist1"><strong>EXCLUDEMATCH</strong></dt>
<dd>
<p>Shell array containing file exclude file pattern list (see <strong>snebu-client.conf(5)</strong>)</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_examples_2">Examples</h4>
<div class="paragraph">
<p>The following is a template that can be used when backing up a server containing a database.  In this case, the include/exclude list initially includes files to back up the entire server.  So this script does a hot backup of the database first, then adds to the exclude list the dbf files that were backed up initially, and then backs up the rest of the system.</p>
</div>
<div class="paragraph">
<p>The Since these functions get called at various times from the snebu-client script, the order of the various code fragments can become a bit confusing.  Pay attention to the "(Step x)" labels for the actual execution order in each fragment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>### Snebu backup plugin template for databases

# Initialize an internal housekeeping variable
# (Step 0)
dbstage=0

# Define the pre-backup script
pluginpre() {
    # Stage 0 =&gt; haven't backed up the DB yet
    if [ "${dbstage}" = 0 ]
    then
	# (Step 1)
	# Save the current include/exclude list
	OLD_INCLUDE=( "${INCLUDE[@]}" )
	OLD_EXCLUDE=( "${EXCLUDE[@]}" )
	OLD_EXCLUDEMATCH=( "${EXCLUDEMATCH[@]}" )

	# Zero out exclude list
	EXCLUDE=( )
	EXCLUDEMATCH=( )

	# Set the include list to include database files
	DBF_FILES=( "$(
	    # Function to list database filenames to standard output
	    print_dbf_filenames
	)" )
	INCLUDE=( "${DBF_FILES[@]}" )

	# Place DB in hot backup mode
	begin_db_backup

	# After this, snebu-client-backup takes over and backs up
	# the above set include list.  Then control jumps to
	# pluginpost() with dbstage still set to 0
    elif [ "${dbstage}" = 1 ]
    then
	# (Step 3)
	DBF_LOG_FILES=( "$(
	    # Function to list archived transaction logs
	    print_dbf_log_filenames
	)" )
	INCLUDE=( "${DBF_LOG_FILES[@]}" )

	# Back to the backup with the new include list, then
	# off to pluginpost again with dbstage set to 1
    fi
}

pluginpost() {
    if [ "${dbstage}" = 0 ]
    then
	# (Step 2)
	# Take DB out of hot backup mode
	end_db_backup

	# Define the next stage, and repeat the backup
	dbstage=1
	bkrepeat=1

	# Now control jumps back to pluginpre() with dbstage=1
    elif [ "${dbstage}" = 1 ]
    then
	# (Step 4)
	# Restore the original include/exclude list, with the
	# database files added to the exclude list.
	INCLUDE=( "${OLD_INCLUDE[@]}" )
	EXCLUDE=( "${OLD_EXCLUDE[@]}" "${DBF_FILES[@]}" 	"${DBF_LOG_FILES[@]}"
	EXCLUDEMATCH=( "${OLD_EXCLUDEMATCH[@]}" )

	# Define the next stage, and repeat the backup
	dbstage=2
	bkrepeat=1

	# Control jumps back to pluginpre(), however no more pre-
	# processing is needed for stage 2, so the backup begins
	# again with the original client include/exclude (plus the
	# above database files added to the exclude).
    elif [ "${dbstage}" = 2 ]
    then
	# (Step 5)
	# Break the cycle, backup is completed for this host.
	bkrepeat=0
    fi
}

# Also, don't forget to fill in the functions referenced above:

begin_db_backup() {
    ### Steps to place DB in hot backup mode
}

end_db_backup() {
    ### Steps to DB out of hot backup mode
}

print_dbf_filenames() {
    ### Output list of dbf file names
}

print_dbf_log_filenames() {
    ### Output list of archived transaction log file names
}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu1_the_simple_network_backup_system">4.8. snebu(1) - The simple network backup system</h3>
<div class="listingblock">
<div class="content">
<pre>snebu [ -c | --config filepath ] subcommand [ options ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_8">Description</h4>
<div class="paragraph">
<p>The <em>snebu</em> command is a backup tool which manages storing data from
backup sessions on disk-based storage, utilizing a simple database
for tracking backup sets and meta data.  With the exception of administrative
sub commands (expire, purge, permissions), it is typically it is called via a
front end script (such as the included "snebu-client" shell script).
The subcommands are listed below along with the most common options.
Details on each command are given in each command&#8217;s individual man page.</p>
</div>
<h4 id="_sub_commands_are_as_follows_2" class="discrete">Sub commands are as follows:</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>newbackup</strong> <strong>-n</strong> <em>backupname</em> <strong>-d</strong> <em>datestamp</em> <strong>-r</strong> <em>schedule</em></dt>
<dd>
<p>Initiates a new backup set, taking in the full backup manifest,
returning a snapshot manifest.</p>
</dd>
<dt class="hdlist1"><strong>submitfiles</strong> <strong>-n</strong> <em>backupname</em> <strong>-d</strong> <em>datestamp</em></dt>
<dd>
<p>Receives a backup in TAR format that fulfills the snapshot manifest returned from newbackup</p>
</dd>
<dt class="hdlist1"><strong>restore</strong> <strong>-n</strong> <em>backupname</em> <strong>-d</strong> <em>datestamp</em> [ <em>file_list&#8230;&#8203;</em> ]</dt>
<dd>
<p>Generates a tar file containing the specified backup set.</p>
</dd>
<dt class="hdlist1"><strong>listbackups</strong> [ <strong>-n</strong> <em>backupname</em> [ <strong>-d</strong> <em>datestamp</em> ]] [ <em>file_list&#8230;&#8203;</em> ]</dt>
<dd>
<p>List backed up hosts, backup sets within a host, or files within a backup set.</p>
</dd>
<dt class="hdlist1"><strong>expire</strong> [ <strong>-n</strong> <em>backupname</em> <strong>-d</strong> <em>datestamp</em> ] or [ <strong>-a</strong> <em>days</em> <strong>-r</strong> <em>schedule</em> [ <strong>-n</strong> <em>hostname</em> ]]</dt>
<dd>
<p>Expires (removes) the given backup set, or backups matching the given criteria</p>
</dd>
<dt class="hdlist1"><strong>purge</strong></dt>
<dd>
<p>Purges backing files from the vault that are part of expired backups</p>
</dd>
<dt class="hdlist1"><strong>permissions</strong></dt>
<dd>
<p>[ <strong>-l</strong> | <strong>-a</strong> | <strong>-r</strong> ]
<strong>-c</strong> <em>command</em>
<strong>-n</strong> <em>hostname</em>
<strong>-u</strong> <em>user</em>
Defines permissions for a given user, when snebu is run in multi-user mode.</p>
</dd>
<dt class="hdlist1"><strong>help</strong> [subcommand]</dt>
<dd>
<p>Displays help page of subcommand</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_5">See Also</h4>
<div class="paragraph">
<p><strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_newbackup1_submits_manifest_for_a_new_backup">4.9. snebu-newbackup(1) - Submits manifest for a new backup</h3>
<div class="listingblock">
<div class="content">
<pre>snebu newbackup -n backupname -d datestamp -r schedule</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_9">Description</h4>
<div class="paragraph">
<p>The "newbackup" command creates a new backup set, by consuming a
tab-delimited list of file names (along with associated meta data) to
include in the backup.  It then compares this list to the backup
catalog database to determine which files are new, and which ones are
already contained on the backup media.  A list of new / changed files
is returned (the snapshot manifest), which can then be passed along to
"tar" to generate the input for the "submitfiles" subcommand.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_5">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date
+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>-r</strong>, <strong>--retention</strong> <em>schedule</em></dt>
<dd>
<p>Retention schedule for this backup set.  Typical
values are "daily", "weekly", "monthly", "yearly".</p>
</dd>
<dt class="hdlist1"><strong>-T</strong>, <strong>--files-from</strong> <em>FILE</em></dt>
<dd>
<p>Read list of filenames (with meta data) to backup
from the named file, instead of standard input.</p>
</dd>
<dt class="hdlist1"><strong>--null</strong></dt>
<dd>
<p>Inbound backup manifest (<strong>-T</strong>, or standard input)
is null terminated</p>
</dd>
<dt class="hdlist1"><strong>--not-null</strong></dt>
<dd>
<p>Inbound backup manifest (<strong>-T</strong>, or standard input)
is newline terminated</p>
</dd>
<dt class="hdlist1"><strong>--null-output</strong></dt>
<dd>
<p>Generate snapshot manifest with null-terminated lines.</p>
</dd>
<dt class="hdlist1"><strong>--not-null-output</strong></dt>
<dd>
<p>Generate snapshot with newline-terminated lines.</p>
</dd>
<dt class="hdlist1"><strong>-f</strong>, <strong>--force-full</strong></dt>
<dd>
<p>Force a full backup</p>
</dd>
<dt class="hdlist1"><strong>--graft</strong> <em>/path/name/</em>*=*<em>/new/name/</em></dt>
<dd>
<p>Re-write path names beginning with "<em>/path/name/</em>"
to "<em>/new/name/</em>"</p>
</dd>
<dt class="hdlist1"><strong>-v</strong></dt>
<dd>
<p>Turn on verbose output.</p>
</dd>
</dl>
</div>
<h4 id="_input_manifest_format" class="discrete">Input Manifest format</h4>
<div class="paragraph">
<p>The input manifest contains a list of files to include in this backup set.
The format is a delimited list of file names and file metadata, with the following fields:
.BP</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>1 - FType</strong></dt>
<dd>
<p>Values are one of "f", "d", "l", "c", "b"</p>
</dd>
<dt class="hdlist1"><strong>2 - Mode</strong></dt>
<dd>
<p>File mode in octal</p>
</dd>
<dt class="hdlist1"><strong>3 - Device</strong></dt>
<dd>
<p>Device number of file system</p>
</dd>
<dt class="hdlist1"><strong>4 - Inode</strong></dt>
<dd>
<p>Inode number of file</p>
</dd>
<dt class="hdlist1"><strong>5 - UName</strong></dt>
<dd>
<p>User name</p>
</dd>
<dt class="hdlist1"><strong>6 - UID</strong></dt>
<dd>
<p>User ID number</p>
</dd>
<dt class="hdlist1"><strong>7 - GName</strong></dt>
<dd>
<p>User&#8217;s Group Name</p>
</dd>
<dt class="hdlist1"><strong>8 - GID</strong></dt>
<dd>
<p>User&#8217;s Group Number</p>
</dd>
<dt class="hdlist1"><strong>9 - Size</strong></dt>
<dd>
<p>File size in bytes</p>
</dd>
<dt class="hdlist1"><strong>10 - Hash</strong></dt>
<dd>
<p>File Hash (future use, set to "0")</p>
</dd>
<dt class="hdlist1"><strong>11 - CTime</strong></dt>
<dd>
<p>File Inode&#8217;s last change time</p>
</dd>
<dt class="hdlist1"><strong>12 - MTime</strong></dt>
<dd>
<p>File Content&#8217;s last modififed time</p>
</dd>
<dt class="hdlist1"><strong>13 - Path</strong></dt>
<dd>
<p>Full file path</p>
</dd>
<dt class="hdlist1"><strong>14 - LTarget</strong></dt>
<dd>
<p>Link target</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Field 14 (Link Target) is only present if the file type is "l" (symbolic link).</p>
</div>
<div class="paragraph">
<p>The fields are tab-delimited.  If the "--null" option is specified, then each line is null terminated, with an additional null character delimiting fields 13 and 14.  Otherwise if "--not-null" is specified, fields 13 and 14 are tab delimited, and the path names must have special characters escaped.</p>
</div>
<div class="paragraph">
<p>The input manifest can be created with the GNU <em>find</em> command, with the following print formatting specification (suitable for the "--null" flag):</p>
</div>
<div class="paragraph">
<div class="title">EX</div>
<p>find [ parameters ] \( -type f -o -type d \ .br
    -printf "%y\t%#m\t%D\t%i\t%u\t%U\t%g\t%G\t%s\t0\t%C@\t%T@\t%p\0" .br
    -o -type l -printf "%y\t%#m\t%D\t%i\t%u\t%U\t%g\t%G\t%s\t0\t%C@\t%T@\t%p\0%l\0"
.EE</p>
</div>
<h4 id="_returned_snapshot_manifest_output" class="discrete">Returned Snapshot manifest output</h4>
<div class="paragraph">
<p>The manifest returned is either a null-delimited list of files (if "--null-output" is specified),
or a newline-delimited list of files with special characters escaped (if "--not-null-output is specified).
This is the list of files that are required to complete the snapshot (any file that hasn&#8217;t changed from previous backups will be referenced from the backup server).  This list is suitable for passing into the <em>tar</em> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_6">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_submitfiles1_recieves_tar_file_contents_to_complete_a_backup">4.10. snebu-submitfiles(1) - Recieves tar file contents to complete a backup</h3>
<div class="listingblock">
<div class="content">
<pre>snebu submitfiles -n backupname -d datestamp</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_10">Description</h4>
<div class="paragraph">
<p>The "submitfiles" sub command is called after running <em>snebu&nbsp;newbackup</em>,
and is used to submit a tar file containing the files from the snapshot manifest returned by <em>newbackup</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_6">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.
Typically set to the server name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.
The format is in time_t format, sames as the output of the "date&nbsp;+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>-v</strong></dt>
<dd>
<p>Verbose output</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_7">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_listbackups1_lists_backed_up_systems_backup_sets_and_file_names">4.11. snebu-listbackups(1) - Lists backed up systems, backup sets, and file names</h3>
<div class="listingblock">
<div class="content">
<pre>snebu  listbackups [ -n hostname ] [ -d datestamp ]] [ file_list... ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_11">Description</h4>
<div class="paragraph">
<p>With no arguments specified, <em>listbackups</em> will return a list of all
systems that are contained in the backup catalog.  Otherwise, when
specifying the <strong>-n</strong> parameter, a list of backup sets for that host is
returned.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_7">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date
+%s" command.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files or file pattern(s)</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_8">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_restore1_generates_tar_file_from_backup">4.12. snebu-restore(1) - Generates tar file from backup</h3>
<div class="listingblock">
<div class="content">
<pre>snebu restore -n backupname -d datestamp [ file_list... ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_12">Description</h4>
<div class="paragraph">
<p>Generates a tar file containing files from a given backup set.
Pipe the output of this command into <em>tar</em> to restore files.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_8">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup, as specified in the <em>newbackup</em> subcommand.
Typically is the name of the server that was backed up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date&nbsp;+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>--graft</strong> <em>/path/name/</em>*=*<em>/new/name/</em></dt>
<dd>
<p>Re-write path names beginning with "<em>/path/name/</em>" to "<em>/new/name/</em>".
This allows you to restore a file to a different location.</p>
</dd>
<dt class="hdlist1">[ <em>file-list</em> ]</dt>
<dd>
<p>List of files to restore.  Defaults to all.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_9">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_expire1_expire_a_given_backup_set_or_range_of_backups">4.13. snebu-expire(1) - Expire a given backup set or range of backups</h3>
<div class="listingblock">
<div class="content">
<pre>snebu expire [ -n hostname -d datestamp ] or [ -a days -r schedule [ -n hostname ]]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_13">Description</h4>
<div class="paragraph">
<p>Removes backup sessions from the snebu backup catalog database.
A specific backup session can be purged by providing the <strong>-n</strong> and <strong>-d</strong>
options, or all backups that are part of a given retention schedule
(specified with <strong>-r</strong>, and optionally from a given host, with the <strong>-n</strong>
option) that are older than a given number of days (<strong>-a</strong>) are removed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_9">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>backupname</em></dt>
<dd>
<p>Name of the backup.  Usually set to the server
name that you are backing up.</p>
</dd>
<dt class="hdlist1"><strong>-d</strong>, <strong>--date</strong> <em>datestamp</em></dt>
<dd>
<p>Date stamp for this backup set.  The format is in
time_t format, sames as the output of the "date
+%s" command.</p>
</dd>
<dt class="hdlist1"><strong>-r</strong>, <strong>--retention</strong> <em>schedule</em></dt>
<dd>
<p>Retention schedule for this backup set.  Typical
values are "daily", "weekly", "monthly", "yearly".</p>
</dd>
<dt class="hdlist1"><strong>-a</strong>, <strong>--age</strong> <em>#days</em></dt>
<dd>
<p>Expire backups older than #days.</p>
</dd>
<dt class="hdlist1"><strong>-m</strong>, <strong>--min-keep</strong> <em>#backups</em></dt>
<dd>
<p>When expiring with the <strong>-a</strong> flag, keep at least
this many of the most recent backups for a given
hostname/retention schedule.
Defaults to 3 days.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_10">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_purge1_remove_backing_files_from_expired_backups">4.14. snebu-purge(1) - Remove backing files from expired backups</h3>
<div class="listingblock">
<div class="content">
<pre>snebu purge [ -v ] [ -q ]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_14">Description</h4>
<div class="paragraph">
<p>Permanently removes files from disk storage that are no longer
referenced by any backups. Run this command after running "snebu expire".</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_10">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-v</strong>, <strong>--verbose</strong></dt>
<dd>
<p>Turns on verbose mode (default if stderr is a tty)</p>
</dd>
<dt class="hdlist1"><strong>-q</strong>, <strong>--quiet</strong></dt>
<dd>
<p>Turns off verbose mode (default if stderr is not a tty)</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_11">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-permissions</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snebu_permissions1_set_permissions_for_snebu_when_used_in_multi_user_mode">4.15. snebu-permissions(1) - Set permissions for Snebu when used in multi-user mode</h3>
<div class="listingblock">
<div class="content">
<pre>snebu permissions [ -l | -a | -r ] -c command -n hostname -u user</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_15">Description</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">The <em>permissions</em> command lists, adds, or removes user permissions.</dt>
<dd>
<p>These permissions are applied when the "snebu" command is installed setuid, and run
by a OS different user.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_options_11">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>-l</strong>, <strong>--list</strong></dt>
<dd>
<p>Lists all installed permissions.  If the <strong>-c</strong>, <strong>-n</strong>, or
<strong>-u</strong> options are given, this list is restricted to
those sub commands, hostnames, or users respectively.</p>
</dd>
<dt class="hdlist1"><strong>-a</strong>, <strong>--add</strong></dt>
<dd>
<p>Adds permissions for the specified sub command [-c],
hostname [-n], and user [-u].</p>
</dd>
<dt class="hdlist1"><strong>-r</strong>, <strong>--remove</strong></dt>
<dd>
<p>Removes permissions for the specified sub command
[-c], hostname [-n], and user [-u].</p>
</dd>
<dt class="hdlist1"><strong>-c</strong>, <strong>--command</strong> <em>sub command</em></dt>
<dd>
<p>The sub command that this permission command applies to.</p>
</dd>
<dt class="hdlist1"><strong>-n</strong>, <strong>--name</strong> <em>hostname</em></dt>
<dd>
<p>The host name that this permission command applies to.</p>
</dd>
<dt class="hdlist1"><strong>-u</strong>, <strong>--user</strong> <em>username</em></dt>
<dd>
<p>The user that this permission command applies to.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Available subcomands that work with permissions are:</p>
</div>
<div class="paragraph">
<p><strong>backup</strong> (covers both newbackup and submitfiles functions)</p>
</div>
<div class="paragraph">
<p><strong>restore</strong></p>
</div>
<div class="paragraph">
<p><strong>listbackups</strong></p>
</div>
<div class="paragraph">
<p><strong>expire</strong></p>
</div>
<div class="paragraph">
<p><strong>purge</strong></p>
</div>
<div class="paragraph">
<p><strong>permissions</strong></p>
</div>
<div class="paragraph">
<p>Note that in the case of functions that aren&#8217;t host specific (such as <em>permissions</em>) or    affect all hosts (<em>snebu purge</em>, or <em>snebu expire -a &#8230;&#8203;</em>), users will need to be granted permission to all hosts by specifying <strong>-h '*'</strong> in order to be granted access to those specific functions).</p>
</div>
<div class="paragraph">
<p>To grant permissions, this command must be run as the user that snebu is
installed under, or the user must be granted access to the <em>permissions</em>
sub command</p>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_12">See Also</h4>
<div class="paragraph">
<p><strong>snebu</strong>(1),
<strong>snebu-newbackup</strong>(1),
<strong>snebu-submitfiles</strong>(1),
<strong>snebu-restore</strong>(1),
<strong>snebu-listbackups</strong>(1),
<strong>snebu-expire</strong>(1),
<strong>snebu-purge</strong>(1),
<strong>snebu-client</strong>(1)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tarcrypt1_compresses_and_encrypts_file_data_in_tar_files">4.16. tarcrypt(1) - Compresses and encrypts file data in TAR files</h3>
<div class="listingblock">
<div class="content">
<pre>tarcrypt encrypt -k keyfile
 tarcrypt decrypt
 tarcrypt genkey -f keyfile -c comment</pre>
</div>
</div>
<div class="sect3">
<h4 id="_description_16">Description</h4>
<div class="paragraph">
<p>The <em>tarcrypt</em> command acts as a filter for the <em>tar</em> command.
In encryption mode, it will compress and encrypt the data portion of TAR files
while leaving header metadata intact.  This allows the TAR file to be sent to
a backup system that expects the Unix TAR format as input.</p>
</div>
<div class="paragraph">
<p>The key file that is generated by the <em>genkey</em> function contains an encrypted
(passphrase protected) RSA private key, public key, and HMAC key used for verification.
The encrypted private key, public key, and a hash of the HMAC key are stored in
the TAR file&#8217;s global header.</p>
</div>
<div class="paragraph">
<p>Each individual file is encrypted with a random AES-256 key, which is in turn encrypted
using the RSA public key.  The file contents is also signed using the HMAC key,
and the signature for the file is attached to the file header.</p>
</div>
<div class="paragraph">
<p>During a decrypt operation, the user is prompted for the passphrase protecting the private key,
which is used to decrypt the AES key stored with each file.
The passphrase, along with the public key hash, are used to re-create the secret HMAC key
in order to validate each file contents as it is begin decrypted.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_12">Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>encrypt</strong></dt>
<dd>
<p>Reads the tar command output on standard input, outputting an encrypted tar file.
    <strong>Parameters</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>-k</strong>, <strong>--keyfile</strong> <em>keyfilename</em><br>
Specifies the key file (generated by the <em>genkey</em> subcommand)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Multiple key files may be specified by repeating this parameter.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>decrypt</strong></dt>
<dd>
<p>Reads an encrypted tar file on standard input, prompts for the passphrase,
decrypts and verifies contents outputting a standard tar file.</p>
</dd>
<dt class="hdlist1"><strong>genkey</strong></dt>
<dd>
<p>Generates a key file used by the <em>encrypt</em> function.
    <strong>Parameters:</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>-f</strong>, <strong>--filename</strong> <em>keyfilename</em><br>
Specifies the filename to write the keyfile out to.</p>
</li>
<li>
<p>[ <strong>-c</strong>, <strong>--comment</strong> "<em>comment text</em>" ]<br>
Specifies a comment to include in the keyfile.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_security">Security</h4>
<div class="paragraph">
<p>Public Key cryptography splits up a key into two parts&#8201;&#8212;&#8201;an encryption (public) key, and a decryption (private) key.
The public key isn&#8217;t considered sensitive&#8201;&#8212;&#8201;it is designed so that one party can send encrypted data to another party,
by using the other party&#8217;s public key.  The private key, however, needs to be kept confidential by the receiving party.
Typically the private key is stored encrypted with a symmetric algorithm (one where the same password is used to both encrypt
and decrypt the data) to provide additional security.</p>
</div>
<div class="paragraph">
<p>In the case of tarcrypt, the sending and receiving party is the same entity,
using a third party (the backup server) to store the encrypted data.
If the backup is needed, chances are that the keyfile used to encrypt the backup is lost also.
Therefore, both the public key (for reference), and an encrypted copy of the private key are stored
in the generated encrypted tar file&#8217;s global header.</p>
</div>
<div class="paragraph">
<p>For the purpose of file confidentiality the keyfile isn&#8217;t considered sensitive,
as the private key used to decrypt the data is stored in encrypted form.
However, the keyfile also contains a secret HMAC key used to authenticate the contents of the encrypted
tar file.  Therefore if authenticity is needed, then the keyfile must be kept confidential
(i.e., stored with appropriate file system permissions to be accessed only by the backup process).</p>
</div>
</div>
<div class="sect3">
<h4 id="_notes">Notes</h4>
<div class="paragraph">
<p>The tarcrypt file format is an extension of the PAX TAR format, with custom values in the PAX header.
If used in conjunction with a backup tool which expects the TAR format as input,
then the backup tool may need some modifications in order to handle the extensions.
If the tool stores the tar file intact, and if it doesn&#8217;t choke on the custom header fields,
then no modifications should be necessary.  However if the backup system parses out the TAR file format
(i.e., it if uses it as a serialization format), then it would need to be modified to store the encrypted
header info along with the rest of the metadata, and re-generate the appropriate global and individual
file headers.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>